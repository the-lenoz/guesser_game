#include <stdlib.h>
#include <stdio.h>
#include <assert.h>
#include <string.h>

#include "tree.h"


static int destroy_node_cb(tree *node) {
  if (node) {
    free(node->value);
    free(node);
  }    
  return 0;
}

tree *tree_init() {
  tree *t = calloc(sizeof(tree), 1);
  return t;
}
int tree_destroy(tree *t) {
  tree_DFS(t, destroy_node_cb, POSTFIX);
  return 0;  
}


treeStatus tree_check(tree *t) {
  if (!t)
    return -1;
  return 0;  
}

treeStatus tree_print(tree *t, FILE *fp) {
  assert(fp);

  if (!t)
    return fprintf(fp, "nil"), -1;

  putc('(', fp);
  
  putc('"', fp);
  fputs(t->value, fp);
  putc('"', fp);
  putc(',', fp);
  
  tree_print(t->lchild, fp);
  putc(',', fp);

  tree_print(t->rchild, fp);

  putc(')', fp);

  return 0;
}

treeStatus tree_DFS(tree *t, trav_cb callback, trav_t trav_type) {
  if (!t)
    return -1;

  if (trav_type == PREFIX)
    callback(t);

  tree_DFS(t->lchild, callback, trav_type);

  if (trav_type == INFIX)
    callback(t);

  tree_DFS(t->rchild, callback, trav_type);

  return 0;  
}

static char *read_str(FILE *fp) {
  if (getc(fp) != '"')
    return NULL;
  char *s = NULL;
  size_t len = 0;
  getdelim(&s, &len, '"', fp);
  s[strlen(s) - 1] = '\0';
  return s;
}    

tree *read_tree(FILE *fp) {
  tree *t = NULL;
  if (getc(fp) == '(') {
    t = tree_init();
    t->value = read_str(fp);
    if (!t->value) {
      getc(fp); getc(fp); // nil, swallow it
    }      
    getc(fp); // skip comma
    t->lchild = read_tree(fp);
    getc(fp); // skip comma
    t->rchild = read_tree(fp);
    getc(fp); // swallow ')'
  } else {
    getc(fp); getc(fp); // Non-'(' means nil; Swallow it
  } 

  return t;
}    
